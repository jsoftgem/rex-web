angular.module("customerController",["fluid","ngResource","datatables"]).controller("customerCtrl",["$scope","DTOptionsBuilder","DTColumnBuilder","flowMessageService","flowModalService","$compile","$filter","sessionService","userProfile",function(s,dto,dtc,ms,fm,c,f,ss,up){s.userProfile=up,s.deleleModalId="customerDeleteModal",s.create_name="customer_create",s.edit_name="customer_edit",s.home="customer",s.submit_button="customer_submit",s.getPositionName="services/war/position_query/position_name?id=",s.task.contactTemp={},s.task.levelTemp={},s.task.publisherTemp={},s.task.supportTemp={},s.task.potentialTemp={},s.task.tempSchoolYear={},s.task.edit={},s.task.edit.agent={},s.task.create={},s.task.create.agent={};var create=new CreateControl;create.id="customer_create_ctl",create.action=function(){s.flow.goTo(s.create_name)},create.pages=s.home;var save=new SaveControl;save.id="customer_save_ctl",save.action=function(){$("#"+s.flow.getElementFlowId(s.submit_button)).trigger("click")},save.pages=[s.edit_name,s.create_name];var delCtl=new DeleteControl;delCtl.id="customer_del_ctl",delCtl.action=function(){fm.show(s.flow.getElementFlowId(s.deleleModalId))},delCtl.pages=s.edit_name,s.flow.controls=[create,save,delCtl],s.dtOptions=new FlowOptionsGET(dto,s.flow.getHomeUrl(),s,c,ss),s.dtColumns=FlowColumns(dtc),s.dtColumns.push(dtc.newColumn("customerCode").withTitle("Customer code").withOption("searchable",!0)),s.dtColumns.push(dtc.newColumn("school.name").withTitle("Name").withOption("searchable",!0)),s.dtColumns.push(dtc.newColumn("regionCode").withTitle("Region").withOption("searchable",!0)),s.dtColumns.push(dtc.newColumn("ownerName").withTitle("Material Advisor").withOption("searchable",!0)),s.edit=function(id){s.flow.goTo(s.edit_name,id)},s.view=function(customer){if(console.info("customer",customer),customer){var param=customer.id;s.flow.openTask("customer_agent_task","customer_agent_summary",param,!1,{source:"customer",agent:{id:customer.ownerAgentId,fullName:customer.ownerName}})}},s["delete"]=function(id){fm.show(s.flow.getElementFlowId(s.deleleModalId)),s.http.get("services/war/customer_query/getInstance/",id).success(function(data){s.task.customerEdit=data})},s.save=function(){s.task.page.name===s.edit_name?angular.equals(s.task.customerEdit,s.task.tempEdit)?s.flow.message.info(UI_MESSAGE_NO_CHANGE):s.flow.action("put",s.task.customerEdit,s.task.customerEdit.id):s.task.page.name===s.create_name&&s.flow.action("put",s.task.customerCreate)},s.$on(s.flow.event.getSuccessEventId(),function(event,data,method){"put"===method&&(s.task.page.name===s.edit_name?(s.task.customerEdit={},angular.copy(s.task.customerEdit,s.task.tempEdit),console.info("customer-success-origin",s.task.origin),s.task.origin?(s.task.close(),s.flow.navToTask(s.task.origin)):s.flow.goToHome()):s.task.page.name===s.create_name&&(s.task.customerCreate={},s.flow.goToHome()))}),s.$on(s.flow.event.getRefreshId(),function(){s.dtInstance&&s.dtInstance.reloadData()}),s.task.page.load=function(data,source){this.name===s.edit_name?(!s.task.customerEdit.id||source&&"refresh"===source)&&(s.task.origin&&(s.task.tempEdit={}),s.task.customerEdit=data,this.title=s.task.customerEdit.school.name,angular.copy(s.task.customerEdit,s.task.tempEdit),s.task.customerEdit.evaluationTo&&(s.task.isEditEvaluationTo=!0),s.task.customerEdit.orderingTo&&(s.task.isEditOrderingTo=!0),s.task.customerEdit.deliveryTo&&(s.task.isEditDeliveryTo=!0),s.task.customerEdit.collectionTo&&(s.task.isEditCollectionTo=!0)):this.name===s.home?s.dtInstance&&s.dtInstance.reloadData():this.name===s.create_name&&s.task.currentPage===s.create_name&&(s.task.customerCreate={},s.task.school={})},s.deleteConfirm=function(){s.flow.action("delete",s.task.customerEdit,s.task.customerEdit.id),fm.hide(s.flow.getElementFlowId("customerDeleteModal")),s.task.page.name!==s.home&&s.flow.goToHome(),s.dtInstance&&s.dtInstance.reloadData()},s.deleteCancel=function(){fm.hide(s.flow.getElementFlowId("customerDeleteModal"))},s.$on(s.flow.getEventId("createContactEvent"),function(event){s.task.contact={},s.task.contactManaged=!1,s.task.page.name===s.create_name?(void 0===s.task.customerCreate.contactDetails&&(s.task.customerCreate.contactDetails=[]),s.task.customerCreate.contactDetails.push(s.task.contact),s.task.contactIndex=s.task.customerCreate.contactDetails.length-1):s.task.page.name===s.edit_name&&(void 0===s.task.customerEdit.contactDetails&&(s.task.customerEdit.contactDetails=[]),s.task.customerEdit.contactDetails.push(s.task.contact),s.task.contactIndex=s.task.customerEdit.contactDetails.length-1),fm.show(s.flow.getElementFlowId("contactsModal"))}),s.$on(s.flow.getEventId("editContactEvent"),function(event,id,index){s.task.page.name===s.create_name?angular.copy(s.task.customerCreate.contactDetails[index],s.task.contactTemp):s.task.page.name===s.edit_name&&angular.copy(s.task.customerEdit.contactDetails[index],s.task.contactTemp),s.task.contactManaged=!0,s.task.contactIndex=index,fm.show(s.flow.getElementFlowId("contactsModal"))}),s.closeContactModal=function(){s.task.contactManaged===!1?s.task.page.name===s.create_name?s.task.customerCreate.contactDetails.splice(s.task.contactIndex,1):s.task.page.name===s.edit_name&&s.task.customerEdit.contactDetails.splice(s.task.contactIndex,1):s.task.contactManaged===!0&&(s.task.page.name===s.create_name?s.task.customerCreate.contactDetails[s.task.contactIndex]=s.task.contactTemp:s.task.page.name===s.edit_name&&(s.task.customerEdit.contactDetails[s.task.contactIndex]=s.task.contactTemp),s.task.contactTemp={},s.task.contactIndex=0,s.task.contactManaged=!1),fm.hide(s.flow.getElementFlowId("contactsModal"),s.flow.getElementFlowId("contactDetailsSubTable"))},s.saveContactModal=function(){var valid=!0,contact=void 0;s.task.page.name===s.create_name?contact=s.task.customerCreate.contactDetails[s.task.contactIndex]:s.task.page.name===s.edit_name&&(contact=s.task.customerEdit.contactDetails[s.task.contactIndex]),void 0===contact.level&&(valid=!1,s.flow.message.danger("Education level is required.")),void 0===contact.description&&(valid=!1,s.flow.message.danger("Contact person is required.")),contact.position?s.http.get("services/war/position_query/getInstance/",contact.position).success(function(data){s.task.page.name===s.create_name?s.task.customerCreate.contactDetails[s.task.contactIndex].positionDesc=data.description:s.task.page.name===s.edit_name&&(s.task.customerEdit.contactDetails[s.task.contactIndex].positionDesc=data.description)}):(valid=!1,s.flow.message.danger("Position is required.")),valid===!0&&fm.hide(s.flow.getElementFlowId("contactsModal"),s.flow.getElementFlowId("contactDetailsSubTable"))},s.$on(s.flow.getEventId("createLevelEvent"),function(){s.task.level={},s.task.levelManaged=!1,s.task.page.name===s.create_name?(void 0===s.task.customerCreate.customerLevels&&(s.task.customerCreate.customerLevels=[]),s.task.customerCreate.customerLevels.push(s.task.level),s.task.levelIndex=s.task.customerCreate.customerLevels.length-1):s.task.page.name===s.edit_name&&(void 0===s.task.customerEdit.customerLevels&&(s.task.customerEdit.customerLevels=[]),s.task.customerEdit.customerLevels.push(s.task.level),s.task.levelIndex=s.task.customerEdit.customerLevels.length-1),fm.show(s.flow.getElementFlowId("levelModal"))}),s.$on(s.flow.getEventId("editLevelEvent"),function(event,id,index){s.task.page.name===s.create_name?angular.copy(s.task.customerCreate.customerLevels[index],s.task.levelTemp):s.task.page.name===s.edit_name&&angular.copy(s.task.customerEdit.customerLevels[index],s.task.levelTemp),s.task.levelManaged=!0,s.task.levelIndex=index,fm.show(s.flow.getElementFlowId("levelModal"))}),s.closeLevelModal=function(){s.task.levelManaged===!1?s.task.page.name===s.create_name?s.task.customerCreate.customerLevels.splice(s.task.levelIndex,1):s.task.page.name===s.edit_name&&s.task.customerEdit.customerLevels.splice(s.task.levelIndex,1):s.task.levelManaged===!0&&(s.task.page.name===s.create_name?s.task.customerCreate.customerLevels[s.task.levelIndex]=s.task.levelTemp:s.task.page.name===s.edit_name&&(s.task.customerEdit.customerLevels[s.task.levelIndex]=s.task.levelTemp),s.task.levelTemp={},s.task.levelIndex=0,s.task.levelManaged=!1),fm.hide(s.flow.getElementFlowId("levelModal"),s.flow.getElementFlowId("customerLevelsSubTable"))},s.saveLevelModal=function(){var customerLevel=void 0;s.task.page.name===s.create_name?customerLevel=s.task.customerCreate.customerLevels[s.task.levelIndex]:s.task.page.name===s.edit_name&&(customerLevel=s.task.customerEdit.customerLevels[s.task.levelIndex]);var valid=!0;customerLevel.level?s.http.get("services/war/level_query/getInstance/",customerLevel.level).success(function(data){s.task.page.name===s.create_name?(s.task.customerCreate.customerLevels[s.task.levelIndex].educationLevel=data.description,s.task.customerCreate.customerLevels[s.task.levelIndex].levelCourse=data.levelCourse):s.task.page.name===s.edit_name&&(s.task.customerEdit.customerLevels[s.task.levelIndex].educationLevel=data.description,s.task.customerEdit.customerLevels[s.task.levelIndex].levelCourse=data.levelCourse)}):(valid=!1,s.flow.message.danger("Level is required")),valid&&fm.hide(s.flow.getElementFlowId("levelModal"),s.flow.getElementFlowId("customerLevelsSubTable"))},s.$on(s.flow.getEventId("createPublisherEvent"),function(){s.task.publisher={},s.task.publisherManaged=!1,s.task.page.name===s.create_name?(void 0===s.task.customerCreate.publisher&&(s.task.customerCreate.publisher=[]),s.task.customerCreate.publisher.push(s.task.publisher),s.task.publisherIndex=s.task.customerCreate.publisher.length-1):s.task.page.name===s.edit_name&&(void 0===s.task.customerEdit.publisher&&(s.task.customerEdit.publisher=[]),s.task.customerEdit.publisher.push(s.task.publisher),s.task.publisherIndex=s.task.customerEdit.publisher.length-1),fm.show(s.flow.getElementFlowId("publisherModal"))}),s.$on(s.flow.getEventId("editPublisherEvent"),function(event,id,index){s.task.page.name===s.create_name?angular.copy(s.task.customerCreate.publisher[index],s.task.publisherTemp):s.task.page.name===s.edit_name&&angular.copy(s.task.customerEdit.publisher[index],s.task.publisherTemp),s.task.publisherManaged=!0,s.task.publisherIndex=index,fm.show(s.flow.getElementFlowId("publisherModal"))}),s.closePublisherModal=function(){s.task.publisherManaged===!1?s.task.page.name===s.create_name?s.task.customerCreate.publisher.splice(s.task.publisherIndex,1):s.task.page.name===s.edit_name&&s.task.customerEdit.publisher.splice(s.task.publisherIndex,1):s.task.publisherManaged===!0&&(s.task.page.name===s.create_name?s.task.customerCreate.publisher[s.task.publisherIndex]=s.task.publisherTemp:s.task.page.name===s.edit_name&&(s.task.customerEdit.publisher[s.task.publisherIndex]=s.task.publisherTemp),s.task.publisherTemp={},s.task.publisherIndex=0,s.task.publisherManaged=!1),fm.hide(s.flow.getElementFlowId("publisherModal"),s.flow.getElementFlowId("customerPublisherSubTable"))},s.savePublisherModal=function(){fm.hide(s.flow.getElementFlowId("publisherModal"),s.flow.getElementFlowId("customerPublisherSubTable"))},s.$on(s.flow.getEventId("createSupportEvent"),function(){s.task.support={},s.task.supportManaged=!1,s.task.page.name===s.create_name?(void 0===s.task.customerCreate.supportGivens&&(s.task.customerCreate.supportGivens=[]),s.task.customerCreate.supportGivens.push(s.task.support),s.task.supportIndex=s.task.customerCreate.supportGivens.length-1):s.task.page.name===s.edit_name&&(void 0===s.task.customerEdit.supportGivens&&(s.task.customerEdit.supportGivens=[]),s.task.customerEdit.supportGivens.push(s.task.support),s.task.supportIndex=s.task.customerEdit.supportGivens.length-1),fm.show(s.flow.getElementFlowId("supportModal"))}),s.$on(s.flow.getEventId("editSupportEvent"),function(event,id,index){s.task.page.name===s.create_name?angular.copy(s.task.customerCreate.supportGivens[index],s.task.supportTemp):s.task.page.name===s.edit_name&&angular.copy(s.task.customerEdit.supportGivens[index],s.task.supportTemp),s.task.supportManaged=!0,s.task.supportIndex=index,fm.show(s.flow.getElementFlowId("supportModal"))}),s.closeSupportModal=function(){s.task.supportManaged===!1?s.task.page.name===s.create_name?s.task.customerCreate.supportGivens.splice(s.task.supportIndex,1):s.task.page.name===s.edit_name&&s.task.customerEdit.supportGivens.splice(s.task.supportIndex,1):s.task.supportManaged===!0&&(s.task.page.name===s.create_name?s.task.customerCreate.supportGivens[s.task.supportIndex]=s.task.supportTemp:s.task.page.name===s.edit_name&&(s.task.customerEdit.supportGivens[s.task.supportIndex]=s.task.supportTemp),s.task.supportTemp={},s.task.supportIndex=0,s.task.supportManaged=!1),fm.hide(s.flow.getElementFlowId("supportModal"),s.flow.getElementFlowId("customerSupportSubTable"))},s.saveSupportModal=function(){fm.hide(s.flow.getElementFlowId("supportModal"),s.flow.getElementFlowId("customerSupportSubTable"))},s.$on(s.flow.getEventId("addPotential"),function(event){s.task.potential={},s.task.potentialManaged=!1,s.task.page.name===s.create_name?(void 0===s.task.customerCreate.warCustomerMarketSchoolYears&&(s.task.customerCreate.warCustomerMarketSchoolYears=[]),s.task.customerCreate.warCustomerMarketSchoolYears.push(s.task.potential),s.task.potentialIndex=s.task.customerCreate.warCustomerMarketSchoolYears.length-1):s.task.page.name===s.edit_name&&(void 0===s.task.customerEdit.warCustomerMarketSchoolYears&&(s.task.customerEdit.warCustomerMarketSchoolYears=[]),s.task.customerEdit.warCustomerMarketSchoolYears.push(s.task.potential),s.task.potentialIndex=s.task.customerEdit.warCustomerMarketSchoolYears.length-1),s.onChangeSchoolYear=function(item){s.task.page.name===s.create_name?(s.task.customerCreate.warCustomerMarketSchoolYears[s.task.potentialIndex].schoolYearDescription=item.description,s.task.customerCreate.warCustomerMarketSchoolYears[s.task.potentialIndex].schoolYear=item.id):s.task.page.name===s.edit_name&&(s.task.customerEdit.warCustomerMarketSchoolYears[s.task.potentialIndex].schoolYearDescription=item.description,s.task.customerEdit.warCustomerMarketSchoolYears[s.task.potentialIndex].schoolYear=item.id)},fm.show(s.flow.getElementFlowId("potentialModal"))}),s.$on(s.flow.getEventId("editPotential"),function(event,id,index){s.task.page.name===s.create_name?(angular.copy(s.task.customerCreate.warCustomerMarketSchoolYears[index],s.task.potentialTemp),s.task.tempSchoolYear={description:s.task.customerCreate.warCustomerMarketSchoolYears[index].schoolYearDescription,id:s.task.customerCreate.warCustomerMarketSchoolYears[index].schoolYear}):s.task.page.name===s.edit_name&&(angular.copy(s.task.customerEdit.warCustomerMarketSchoolYears[index],s.task.potentialTemp),s.task.tempSchoolYear={description:s.task.customerEdit.warCustomerMarketSchoolYears[index].schoolYearDescription,id:s.task.customerEdit.warCustomerMarketSchoolYears[index].schoolYear}),s.task.potentialManaged=!0,s.task.potentialIndex=index,fm.show(s.flow.getElementFlowId("potentialModal"))}),s.processOptions=[{label:"Centralized",value:"CENTRALIZED"},{label:"De-centralized",value:"DECENTRALIZED"}],s.natureOfPurchaseOptions=[{label:"Outright",value:"OUTRIGHT"},{label:"Rental",value:"RENTAL"}],s.ownershipOptions=[{label:"Public",value:"PUBLIC"},{label:"Private",value:"PRIVATE"}],s.selectAgent=function(item){s.task.page.name===s.create_name?(s.task.customerCreate.ownerAgentId=s.task.create.agent.id,s.task.customerCreate.regionCode=s.task.create.agent.region):s.task.page.name===s.edit_name&&(s.task.customerEdit.ownerAgentId=s.task.edit.agent.id,s.task.customerEdit.regionCode=s.task.edit.agent.region)},s.validPotential=function(warCustomerMarketSchoolYear){var valid=!0;return s.task.potentialManaged?warCustomerMarketSchoolYear.marketPotential||(ms.danger(s.flow.getElementFlowId("potentialInfoMessage"),"Please input a market potential.",3e3).open(),valid=!1):(warCustomerMarketSchoolYear.schoolYear||(ms.danger(s.flow.getElementFlowId("potentialInfoMessage"),"Please select a school year.",3e3).open(),valid=!1),warCustomerMarketSchoolYear.marketPotential||(ms.danger(s.flow.getElementFlowId("potentialInfoMessage"),"Please input a market potential.",3e3).open(),valid=!1)),valid},s.savePotential=function(){var wcmsy=void 0;s.task.page.name===s.create_name?wcmsy=s.task.customerCreate.warCustomerMarketSchoolYears[s.task.potentialIndex]:s.task.page.name===s.edit_name&&(wcmsy=s.task.customerEdit.warCustomerMarketSchoolYears[s.task.potentialIndex]);var valid=s.validPotential(wcmsy);console.info("valid",valid),valid&&(console.info("wcmsy",wcmsy),wcmsy.marketPotentialSegment=getMarketSegment(wcmsy.marketPotential),fm.hide(s.flow.getElementFlowId("potentialModal")))},s.cancelPotential=function(){s.task.potentialManaged?s.task.page.name===s.create_name?(console.log(s.task.potentialTemp),s.task.customerCreate.warCustomerMarketSchoolYears[s.task.potentialIndex]=s.task.potentialTemp):s.task.page.name===s.edit_name&&(s.task.customerEdit.warCustomerMarketSchoolYears[s.task.potentialIndex]=s.task.potentialTemp):s.task.page.name===s.create_name?s.task.customerCreate.warCustomerMarketSchoolYears.splice(s.task.potentialIndex,1):s.task.page.name===s.edit_name&&s.task.customerEdit.warCustomerMarketSchoolYears.splice(s.task.potentialIndex,1),fm.hide(s.flow.getElementFlowId("potentialModal"))}}]).filter("position",["flowHttpService",function(f){return function(input){return input?f.getGlobal(s.getPositionName+input,!1).success(function(data){return console.log(data),data}).error(function(){return"none"}):"none"}}]).filter("decision",[function(){return function(input){return input&&input?"yes":"no"}}]);