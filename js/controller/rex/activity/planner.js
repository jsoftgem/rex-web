angular.module("plannerModule",["fluid","ngResource","datatables","ngFileUpload"]).controller("plannerCtrl",["$scope","DTOptionsBuilder","DTColumnBuilder","flowMessageService","flowModalService","$compile","$filter","sessionService","HOST","$timeout","flowFrameService","Upload","hasProfile","userProfile","flowHttpService","VIEWER",function(s,dto,dtc,ms,fm,c,f,ss,h,t,ffs,u,hp,up,fh,v){s.submitActivitiesConfirmation=function(){fm.show("submitConfirm")},s.otherActivity={},s.refreshCustomer=!1,s.hangingActivity={},s.calendar={},s.task.hideAgentFilter=!1,s.task.schoolYear=void 0,s.task.agent=void 0,s.task.activities=[],s.task.eventSources=[],s.task.customers=[],s.task.activityModalId=s.flow.getElementFlowId("activity_modal"),s.task.selectedDate={},s.task.planner={},s.task.plannedActivities=[],s.task.unplannedActivities=[],s.task.tempActivity={},s.task.view="month",s.task.tag="20",s.task.customer={},s.task.customer.size=25,s.task.noteQuery="services/war/activity_note_query/get_activity_day?",s.task.showNotes=!1,s.task.showAttach=!1,s.task.plannerCalendar=$("#"+s.flow.getElementFlowId("plannerCal")),s.task.onWindowOpened=function(){s.task.schoolYear=void 0,s.task.agent=void 0,s.task.plannerCalendar.fullCalendar("destroy"),s.task.plannerCalendar.fullCalendar("render"),s.task.plannerCalendar.fullCalendar(s.task.calendar)},s.$on(s.flow.event.getSuccessEventId(),function(event,rv,method){"put"===method&&(s.task.activities=[],s.task.plannerCalendar.fullCalendar("removeEvents"),s.task.plannerCalendar.fullCalendar("refetchEvents"),s.task.planner.id=rv.plannedId)}),s.flow.onRefreshed=function(){s.getPlanner(),s.refetchCustomer(),s.task.plannerCalendar.fullCalendar("refetchEvents")},s.task.viewNotes=function(){s.task.showNotes=!s.task.showNotes,s.task.showAttach=!1,s.task.showNotes===!1&&(s.task.editNote=!1)},s.task.saveNotes=function(note){var promise={};if(void 0===note.id){var year=s.task.selectedDate.getFullYear(),month=monthNames[s.task.selectedDate.getMonth()].toUpperCase(),day=s.task.selectedDate.getDate();note.agentId=s.task.agent.id,note.year=year,note.month=month,note.day=day,promise=s.http.put("services/war/activity_note_crud",note)}else promise=s.http.put("services/war/activity_note_crud/",note,note.id);promise.then(function(){s.task.editNote=!1})},s.task.uploadAttachmentUrl="services/upload_service/upload_file?folder=",s.task.attachmentQuery="services/war/planner_attachment_query/attachment_by_school_year?school_year=",s.task.attachmentCrud="services/war/planner_attachment_crud/",s.task.uploadedFiles=[],s.newCustomer=function(){var customer={};return customer.customers=[],customer.size=25,customer.tag="20",customer.start=0,customer.month={},customer.isMonth=!0,customer.week=0,customer.agendId=0,customer.schoolYear=0,customer.page=1,customer},s.customer=s.newCustomer(),s.task.page.load=function(){up.agent.id&&(console.debug("planner-loaded.profile",up),s.task.hideAgentFilter=!up.agent.isManager,s.task.agent=up.agent,s.task.page.title=up.agent.fullName),s.task.plannerCalendar=$("#"+s.flow.getElementFlowId("plannerCal")),s.task.calendar={header:{left:"title",center:"",right:"month basicWeek today prev,next prevYear,nextYear nextMonth,prevMonth"},events:{eventDataTransform:function(eventData){var event={};return event.title=eventData.description,eventData.type===SCHOOL?event.id="event_id_"+s.flow.getElementFlowId(eventData.customerMarketId)+"_"+new Date(eventData.startDt).getTime():(event.id="event_id_"+eventData.type+"_"+new Date(eventData.startDt).getTime(),event.title=eventData.type),event.start=eventData.startDt,event.activity=eventData,eventData.endDt&&(event.end=eventData.endDt),event.editable=eventData.editable,event},url:s.flow.getHomeUrl(),type:"GET",dataFilter:function(data,type){if("json"===type){var activities=JSON.parse(data);s.task.activities=[],s.task.plannedActivities=[],s.task.unplannedActivities=[],angular.forEach(activities,function(activity){activity.planned?s.task.plannedActivities.push(activity):s.task.unplannedActivities.push(activity)}),s.calendar.plannedCount=s.task.plannedActivities.length,s.calendar.unPlannedCount=s.task.unplannedActivities.length}return data},data:function(){return{schoolYear:void 0!==s.task.schoolYear?s.task.schoolYear.id:void 0,agent:void 0!==s.task.agent?s.task.agent.id:void 0}}},hiddenDays:[0],firstDay:1,weekNumbers:!0,weekNumberCalculation:function(moment){var date=moment.toDate();return getWeekOfMonth(date)},fixedWeekCount:!1,height:500,droppable:!0,viewRender:function(view){void 0!==s.task.agent?(s.getPlanner(view),s.customer.previous=0,s.customer.start=0,s.refetchCustomer(),$("#"+s.flow.getElementFlowId("other_activities")+" td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).html()),activityType:$(this).attr("activity-type")}),$(this).draggable({zIndex:99999,revert:!0,revertDuration:0})})):$("#"+s.flow.getElementFlowId("other_activities")+" td div").each(function(){$(this).draggable()&&$(this).draggable("destroy")}),s.task.plannerCalendar.fullCalendar("refetchEvents"),t(function(){s.task.view=s.task.plannerCalendar.fullCalendar("getView").name})},dayRender:function(date,cell){var currentDate=s.task.plannerCalendar.fullCalendar("getDate").toDate(),dayDate=date.toDate(),dataDate=cell.attr("data-date"),cellValueElement=$("table").find(".fc-day-number[data-date='"+dataDate+"']");isDayEnabled(dayDate,currentDate)?(cell.addClass("enabled-day"),cellValueElement.addClass("enabled-day"),cell.addClass("cursor-pointer"),cell.click(function(){t(function(){s.task.selectedDate=dayDate})})):(cell.addClass("disabled-day"),cellValueElement.addClass("disabled-day"))},eventDrop:function(event,delta,revertFunc){var currentDate=s.task.plannerCalendar.fullCalendar("getDate"),evt=s.task.plannerCalendar.fullCalendar("clientEvents",event.id);0===evt.length?isDayEnabled(event.start.toDate(),currentDate.toDate())&&(type===SCHOOL?s.task.plannerCalendar.fullCalendar("renderEvent",event,!0):t(function(){s.otherActivity.hangingEventObject=event,fm.show(s.flow.getElementFlowId("other_activity"))})):event&&(s.flow.message.danger("Customer "+event.title+" is already set for "+event.start.toDate()),revertFunc())},drop:function(date){var currentDate=s.task.plannerCalendar.fullCalendar("getDate"),originalEventObject=$(this).data("eventObject"),copiedEventObject=$.extend({},originalEventObject),customer=void 0,activity={};activity.startDt=date.toDate().getTime(),activity.type=copiedEventObject.activityType;var type=activity.type;SCHOOL===type?(customer=JSON.parse($(this).attr("customer")),copiedEventObject.title=customer.name+" - "+customer.marketSegment,console.info("customer-drop",customer),activity.customerMarketId=customer.id,activity.description=customer.name+" - "+customer.marketSegment,copiedEventObject.id="event_id_"+s.flow.getElementFlowId(activity.customerMarketId)+"_"+date.toDate().getTime()):(activity.customerMarketId=0,copiedEventObject.id="event_id_"+s.flow.getElementFlowId(type)+"_"+date.toDate().getTime()),activity.schoolYear=s.task.schoolYear.id,copiedEventObject.start=date,copiedEventObject.editable=!0,copiedEventObject.activity=activity,copiedEventObject.durationEditable=!1,copiedEventObject.startEditable=!1;var evt=s.task.plannerCalendar.fullCalendar("clientEvents",copiedEventObject.id);0===evt.length?isDayEnabled(date.toDate(),currentDate.toDate())&&(type===SCHOOL?s.task.plannerCalendar.fullCalendar("renderEvent",copiedEventObject,!0):t(function(){s.otherActivity.hangingEventObject=copiedEventObject,fm.show(s.flow.getElementFlowId("other_activity"))})):customer&&s.flow.message.danger("Customer "+customer.customerName+" is already set for "+date.toDate())},eventRender:function(event,element){var currentDate=s.task.plannerCalendar.fullCalendar("getDate").toDate(),eventDate=event.start.toDate();isDayEnabled(eventDate,currentDate)?(element.addClass("event-customer"),event.activity.planned===!1?element.addClass("unplanned"):event.activity.planned===!0&&element.addClass("planned"),!0===event.editable?(element.qtip({id:"qtip_evt_"+event.id+"_"+event.start.toDate().getTime(),content:{title:event.start,text:event.title},hide:{inactive:500}}),element.dblclick(function(){s.task.plannerCalendar.fullCalendar("removeEvents",event.id)}),element.on("doubletap",function(){s.task.plannerCalendar.fullCalendar("removeEvents",event.id)})):event.activity.type===SCHOOL?element.click(function(){var buttonId="edit_button_"+event.id,tooltip=element.qtip({style:"qtip-light",show:!1,id:"qtip_evt#"+event.id,position:{at:"center",my:"center",adjust:{method:"none shift"}},content:{title:{text:event.title,button:!0},text:"<div><ul><li><b>Marterial Adviser: "+event.activity.materialAdviser+"</b></li><li>Worked with the manager: "+(event.activity.workedWith===!0?" Yes":"No")+"</li><li>Exam Copies Distribution: "+(event.activity.ecd===!0?" Yes":"No")+"</li><li>Invitation to Events: "+(event.activity.ite===!0?" Yes":"No")+"</li><li>Confirmation of Events: "+(event.activity.coe===!0?" Yes":"No")+"</li><li>Follow up Payment: "+(event.activity.fp===!0?" Yes":"No")+"</li><li>Giveaways Distribution: "+(event.activity.gd===!0?" Yes":"No")+"</li><li>Delivery of Incentive/Donation: "+(event.activity.doi===!0?" Yes":"No")+"</li><li>Purchase Order: "+(event.activity.po===!0?" Yes":"No")+"</li><li>Delivery of Add'l Order / TRM / Compli...: "+(event.activity.daotrc===!0?" Yes":"No")+"</li><li>Booklist: "+(event.activity.bookList===!0?" Yes":"No")+"</li></ul></div><div class='btn-group btn-group-xs'><button style='display:"+(void 0!==s.task.agent?"block":"none")+"' id='"+buttonId+"' type='button' class='btn btn-info'>Update</button></div>"},hide:{event:"click",inactive:1500},events:{show:function(evt,api){api.elements.tooltip.find("#"+buttonId).click(function(){api.toggle(!1),t(function(){s.hangingActivity.activity=event.activity,angular.copy(s.hangingActivity.activity,s.tempActivity),fm.show(s.flow.getElementFlowId("activity_modal"))})})}}}),api=tooltip.qtip("api");api.toggle(!0)}):event.activity.type===LEAVE?element.click(function(){var buttonId="edit_button_"+event.id,tooltip=element.qtip({style:"qtip-light",show:!1,id:"qtip_evt#"+event.id,position:{at:"center",my:"center",adjust:{method:"none shift"}},content:{title:{text:event.title,button:!0},text:"<div><ul><li><b>Agent: "+event.activity.materialAdviser+"</b></li><li>Reason for leave: "+(void 0!=event.activity.description||null!=event.activity.description?event.activity.description:"N/A")+"</li></ul></div><div class='btn-group btn-group-xs'><button style='display:"+(void 0!==s.task.agent?"block":"none")+"' id='"+buttonId+"' type='button' class='btn btn-info'>Update</button></div>"},hide:{event:"click",inactive:1500},events:{show:function(evt,api){api.elements.tooltip.find("#"+buttonId).click(function(){api.toggle(!1),t(function(){s.hangingActivity.activity=event.activity,angular.copy(s.hangingActivity,s.task.tempActivity),fm.show(s.flow.getElementFlowId("activity_modal"))})})}}}),api=tooltip.qtip("api");api.toggle(!0)}):element.click(function(){var buttonId="edit_button_"+event.id,tooltip=element.qtip({style:"qtip-light",show:!1,id:"qtip_evt#"+event.id,position:{at:"center",my:"center",adjust:{method:"none shift"}},content:{title:{text:event.title,button:!0},text:"<div><ul><li><b>Agent: "+event.activity.materialAdviser+"</b></li><li>Description: "+(void 0!=event.activity.description||null!=event.activity.description?event.activity.description:"N/A")+"</li></ul></div><div class='btn-group btn-group-xs'><button style='display:"+(void 0!==s.task.agent?"block":"none")+"' id='"+buttonId+"' type='button' class='btn btn-info'>Update</button></div>"},hide:{event:"click",inactive:1500},events:{show:function(evt,api){api.elements.tooltip.find("#"+buttonId).click(function(){api.toggle(!1),t(function(){s.hangingActivity.activity=event.activity,angular.copy(s.hangingActivity,s.task.tempActivity),fm.show(s.flow.getElementFlowId("activity_modal"))})})}}}),api=tooltip.qtip("api");api.toggle(!0)})):element.addClass("hide-event")}},s.task.plannerCalendar.fullCalendar(s.task.calendar),s.task.plannerCalendar.fullCalendar("render")},s.calendar.getCurrentDate=function(){return s.task.plannerCalendar.fullCalendar("getDate").toDate()},s.calendar.clearEvents=function(){s.task.plannerCalendar.fullCalendar("removeEvents"),s.task.plannerCalendar.fullCalendar("refetchEvents")},s.calendar.valid=function(){var valid=!0;void 0===s.task.schoolYear&&(s.flow.message.danger("Please select a school year."),valid=!1),void 0===s.task.agent&&(s.flow.message.danger("Please select an agent."),valid=!1);var events=s.task.plannerCalendar.fullCalendar("clientEvents");return 0===events.length&&(s.flow.message.danger("Please plan your activites."),valid=!1),valid},s.calendar.submit=function(){if(s.calendar.valid()){s.getPlanner(),s.task.planner||(s.task.planner={}),s.task.planner.schoolYear=s.task.schoolYear.id,s.task.planner.agentId=s.task.agent.id;var events=s.task.plannerCalendar.fullCalendar("clientEvents"),date=s.task.plannerCalendar.fullCalendar("getDate").toDate();s.task.planner.month=monthNames[date.getMonth()].toUpperCase(),s.task.planner.year=date.getFullYear();for(var i=0;i<events.length;i++){var event=events[i];event.editable&&(s.task.activities.push(event.activity),event.activity.agentId=s.task.agent.id)}var plannerSession={};plannerSession.warPlanner=s.task.planner,plannerSession.activities=s.task.activities,s.flow.action("put",plannerSession),fm.hide("submitConfirm")}},s.otherActivity.submit=function(){if(s.otherActivity.hangingEventObject){var activity=s.otherActivity.hangingEventObject.activity,type=activity.type;type===LEAVE?void 0===activity.description?ms.danger(s.flow.getElementFlowId("other_activity_messages"),"Please fill out reason for leave.",3e3).open():(s.task.plannerCalendar.fullCalendar("renderEvent",s.otherActivity.hangingEventObject,!0),fm.hide(s.flow.getElementFlowId("other_activity"))):type===SEMINAR?void 0===activity.description?ms.danger(s.flow.getElementFlowId("other_activity_messages"),"Please fill out the details.",3e3).open():(s.task.plannerCalendar.fullCalendar("renderEvent",s.otherActivity.hangingEventObject,!0),fm.hide(s.flow.getElementFlowId("other_activity"))):type===OFFICE&&(void 0===activity.description?ms.danger(s.flow.getElementFlowId("other_activity_messages"),"Please fill out the description.",3e3).open():(s.task.plannerCalendar.fullCalendar("renderEvent",s.otherActivity.hangingEventObject,!0),fm.hide(s.flow.getElementFlowId("other_activity"))))}},s.otherActivity.cancel=function(){fm.hide(s.flow.getElementFlowId("other_activity")),s.task.plannerCalendar.fullCalendar("removeEvents",s.otherActivity.hangingEventObject.id)},s.hangingActivity.update=function(){if(angular.equals(s.hangingActivity.activity,s.tempActivity))ms.warning(s.flow.getElementFlowId("activity_messages"),"No changes has been made.",3e3).open();else if(s.hangingActivity.activity.type===SCHOOL)s.http.put(CRUD_ACTIVITY,s.hangingActivity.activity,s.hangingActivity.activity.id).success(function(msg){fm.hide(s.task.activityModalId),s.refetchCustomer()}).error(function(msg){ms.warning(s.flow.getElementFlowId("activity_messages"),msg,3e3).open()});else{var activity=s.hangingActivity.activity,type=activity.type,valid=!0;type===LEAVE?void 0===activity.description&&(ms.danger(s.flow.getElementFlowId("other_activity_messages"),"Please fill out reason for leave.",3e3).open(),valid=!1):type===SEMINAR?void 0===activity.description&&(ms.danger(s.flow.getElementFlowId("other_activity_messages"),"Please fill out the details.",3e3).open(),valid=!1):type===OFFICE&&void 0===activity.description&&(ms.danger(s.flow.getElementFlowId("other_activity_messages"),"Please fill out the description.",3e3).open(),valid=!1),valid&&s.http.put(CRUD_ACTIVITY,s.hangingActivity.activity,s.hangingActivity.activity.id).success(function(msg){fm.hide(s.task.activityModalId),s.refetchCustomer()}).error(function(msg){ms.warning(s.flow.getElementFlowId("activity_messages"),msg,3e3).open()})}},s.hangingActivity.cancel=function(){fm.hide(s.task.activityModalId)},s.buildCustomerQuery=function(){var date=s.task.plannerCalendar.fullCalendar("getDate").toDate(),month=monthNames[date.getMonth()].toUpperCase();return s.customer.month=month,s.customer.weekStart=date.getTime(),s.customer.isMonth="month"===s.task.plannerCalendar.fullCalendar("getView").name,s.task.schoolYear&&(s.customer.schoolYear=s.task.schoolYear.id),s.customer.agentId=s.task.agent.id,console.info("customer",s.customer),PLANNER_CUSTOMERS+"?tag="+s.customer.tag+"&size="+s.customer.size+"&month="+s.customer.month+"&isMonth="+s.customer.isMonth+"&start="+s.customer.start+"&schoolYear="+s.customer.schoolYear+"&agentId="+s.customer.agentId+"&weekStart="+s.customer.weekStart+"&page="+s.customer.page},s.getCustomerMarket=function(){if(void 0!==s.task.agent){var promise=s.http.get(s.buildCustomerQuery());return promise.success(function(customer){s.customer=customer,s.customer.customers||(s.customer=s.newCustomer(),$("#"+s.flow.getElementFlowId("event_body")+" .event-customer td div").each(function(){$(this).removeClass("draggable").addClass("non-draggable"),$(this).draggable()&&$(this).draggable("destroy")}))}),promise.error(function(){s.customer=s.newCustomer()}),promise}},s.getPlanner=function(view){var date=void 0;date=void 0===view?s.task.plannerCalendar.fullCalendar("getDate").toDate():view.intervalStart.toDate();var month=monthNames[date.getMonth()].toUpperCase();if(s.task.schoolYear){var url=QUERY_PLANNER+"?schoolYear="+s.task.schoolYear.id+"&agent="+s.task.agent.id+"&year="+date.getFullYear()+"&month=",promise=s.http.get(url,month);promise.success(function(data){s.task.planner=data}),promise.error(function(){s.task.planner={}})}},s.refetchCustomer=function(){s.refreshCustomer=!0},s.changeTag=function(tag){s.customer.tag=tag,s.customer.start=0,"All"===tag?(s.customer.size=25,s.customer.page=1):s.refetchCustomer()},s.changeSize=function(size){s.customer.size=size,s.customer.start=0,s.customer.page=1},s.next=function(){s.customer.page++,s.customer.start+=s.customer.next?s.customer.next:0;var promise=s.getCustomerMarket();promise&&promise.success(function(){t(function(){$("#"+s.flow.getElementFlowId("event_body")+" .event-customer td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).text()),activityType:"SCHOOL"}),$(this).removeClass("non-draggable").addClass("draggable"),$(this).draggable({helper:function(){return $("<div>").addClass("event-customer-draggable").html($(this).text()).clone()},zIndex:99999,revert:!0,revertDuration:0})}),$("#"+s.flow.getElementFlowId("other_activities")+" td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).html()),activityType:$(this).attr("activity-type")}),$(this).draggable({zIndex:99999,revert:!0,revertDuration:0})})})})},s.prev=function(){s.customer.page--,s.customer.start-=s.customer.previous?s.customer.previous:0;var promise=s.getCustomerMarket();promise&&promise.success(function(){t(function(){$("#"+s.flow.getElementFlowId("event_body")+" .event-customer td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).text()),activityType:"SCHOOL"}),$(this).removeClass("non-draggable").addClass("draggable"),$(this).draggable({helper:function(){return $("<div>").addClass("event-customer-draggable").html($(this).text()).clone()},zIndex:99999,revert:!0,revertDuration:0})}),$("#"+s.flow.getElementFlowId("other_activities")+" td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).html()),activityType:$(this).attr("activity-type")}),$(this).draggable({zIndex:99999,revert:!0,revertDuration:0})})})})},s.selectSize=function(size){s.customer.size=size,s.refetchCustomer()},s.opentCustomerSummary=function(customerId){if(s.task.schoolYear&&s.task.agent){var param=customerId+"?schoolYear="+s.task.schoolYear.id;s.flow.openTask("customer_agent_task","customer_agent_summary",param,!1,{source:"planner",agent:s.task.agent,schoolYear:s.task.schoolYear})}},s.task.viewAttach=function(){s.task.showAttach=!s.task.showAttach,s.task.showNotes=!1,s.task.showAttach&&s.http.post(s.task.attachmentQuery,void 0,s.task.schoolYear.id).success(function(attachments){s.task.uploadedFiles=attachments}).then(function(){s.task.uploadedFiles||(s.task.uploadedFiles=[])}),s.task.attachPrompt&&s.task.deleteAttachCancel()},s.task.refreshAttach=function(){s.task.attachRefresh=!0,s.task.showAttach&&s.http.post(s.task.attachmentQuery,void 0,s.task.schoolYear.id).success(function(attachments){s.task.uploadedFiles=attachments}).then(function(){s.task.attachRefresh=!1})},s.task.addToFileList=function(file){s.task.attachPrompt&&(s.task.attachPrompt=!1,s.task.deleteAttachId=void 0),console.debug("files",file);var newFile={};angular.copy(file,newFile);var folder="group.school_year."+s.task.schoolYear.id,url=s.task.uploadAttachmentUrl+folder+"&file-name="+file.name;console.debug("file",file);var attachment={};attachment.done=!1,attachment.fileName=file.name,attachment.fileType=file.type,attachment.schoolYear=s.task.schoolYear.id,s.task.uploadedFiles.push(attachment),u.upload({url:withHost(url),headers:{flowPage:s.task.currentPage},file:file}).progress(function(event){console.info("progress",event),attachment.total=event.total,attachment.progress=event.loaded}).success(function(flowUploadedFile){attachment.done=!0,attachment.progress=void 0,attachment.total=void 0,attachment.uploadedFileId=flowUploadedFile.id,console.info("success-upload",flowUploadedFile),s.http.put(s.task.attachmentCrud,attachment).success(function(){s.task.refreshAttach()})})},s.task.download=function(uploadFieldId){return fh.host+"services/download_service/getContent/"+uploadFieldId},s.task.downloadInfo=function(uploadFieldId){return s.http.get("services/download_service/getInfo/",uploadFieldId)},s.task.deleteAttach=function(attachment){s.task.deleteAttachId=attachment.id,s.task.attachPrompt=!0},s.task.deleteAttachCancel=function(){s.task.attachPrompt=!1,s.task.deleteAttachId=void 0,s.task.refreshAttach()},s.task.deleteAttachConfirmed=function(){s.http["delete"](s.task.attachmentCrud,s.task.deleteAttachId).then(function(){s.task.attachPrompt=!1,s.task.deleteAttachId=void 0,s.task.refreshAttach()})},s.task.closeViewer=function(){s.task.attachmentView=void 0,s.task.viewerFile=void 0,fm.hide(s.flow.getElementFlowId("attachment_viewer")),s.task.refreshAttach()},s.task.openViewer=function(attachment){s.task.attachmentView=attachment,s.task.viewerFile=v+h+"services/download_service/getContent/"+attachment.uploadedFileId,fm.show(s.flow.getElementFlowId("attachment_viewer"))},s.$watch(function(scope){return scope.refreshCustomer},function(newValue){if(newValue===!0){void 0!==s.customer.previous&&(s.customer.start=s.customer.previous),console.info("refreshCustomer",newValue);var promise=s.getCustomerMarket();promise&&promise.success(function(){t(function(){$("#"+s.flow.getElementFlowId("event_body")+" .event-customer td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).text()),activityType:"SCHOOL"}),$(this).removeClass("non-draggable").addClass("draggable"),$(this).draggable({helper:function(){return $("<div>").addClass("event-customer-draggable").html($(this).text()).clone()},zIndex:99999,revert:!0,revertDuration:0})}),$("#"+s.flow.getElementFlowId("other_activities")+" td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).html()),activityType:$(this).attr("activity-type")}),$(this).draggable({zIndex:99999,revert:!0,revertDuration:0})})})}),s.refreshCustomer=!1}}),s.$watch(function(scope){return scope.customer.size},function(size){s.selectSize(size)}),s.$watch(function(scope){return scope.task.schoolYear},function(schoolYear){if(void 0!==schoolYear){var date=new Date(schoolYear.date);s.task.plannerCalendar.fullCalendar("gotoDate",date),s.task.plannerCalendar.fullCalendar("refetchEvents"),s.refetchCustomer(),s.task.showAttach&&s.http.post(s.task.attachmentQuery,void 0,s.task.schoolYear.id).success(function(attachments){s.task.uploadedFiles=attachments}).then(function(){s.task.uploadedFiles||(s.task.uploadedFiles=[])})}}),s.$watch(function(scope){return scope.task.agent},function(agent){agent?(s.customer.start=0,s.getCustomerMarket().success(function(){t(function(){$("#"+s.flow.getElementFlowId("other_activities")+" td div").each(function(){$(this).data("eventObject",{title:$.trim($(this).html()),activityType:$(this).attr("activity-type")}),$(this).draggable({zIndex:99999,revert:!0,revertDuration:0})})})})):(s.customer=s.newCustomer(),$("#"+s.flow.getElementFlowId("other_activities")+" td div").each(function(){$(this).draggable()&&$(this).draggable("destroy")})),s.task.plannerCalendar&&s.task.plannerCalendar.fullCalendar("refetchEvents")}),s.$watch(function(scope){return scope.task.selectedDate},function(newValue){if(newValue&&s.task.agent){s.task.dailyNote={};var year=s.task.selectedDate.getFullYear(),month=monthNames[s.task.selectedDate.getMonth()].toUpperCase(),day=s.task.selectedDate.getDate(),url=s.task.noteQuery;url+="agentId="+s.task.agent.id,url+="&year="+year,url+="&month="+month,url+="&day="+day,s.http.post(url).success(function(note){s.task.dailyNote=note})}})}]);